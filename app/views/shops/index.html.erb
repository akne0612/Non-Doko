<div class="py-5" style="background:#f6efe6;">
  <div class="container">

    <!-- ヘッダー -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3 fw-bold m-0">お店を探す</h1>
      <%= link_to "投稿一覧へ", posts_path, class: "btn btn-outline-secondary" %>
    </div>

    <!-- 検索フォーム -->
    <div class="bg-white rounded-4 p-3 p-md-4 shadow-sm mb-4">
      <%= form_with url: shops_path, method: :get, local: true, class: "row g-2 g-md-3 align-items-center" do %>
        <div class="col-12 col-lg-4">
          <%= text_field_tag :place, params[:place], class: "form-control form-control-lg rounded-3", placeholder: "地名・駅名・住所（例：栄駅／バンテリンドーム）" %>
        </div>
        <div class="col-12 col-md-3">
          <%= text_field_tag :q, params[:q], class: "form-control form-control-lg rounded-3", placeholder: "キーワード（例：焼き鳥 個室）" %>
        </div>
        <div class="col-6 col-md-3">
          <%= select_tag :genre_id,
                options_for_select([["ジャンル", ""]] + @genres.map { |g| [g.name, g.id] }, params[:genre_id]),
                class: "form-select form-select-lg rounded-3" %>
        </div>
        <div class="col-6 col-md-2">
          <%= select_tag :radius_km,
                options_for_select([["半径なし", ""]] + [["半径3km",3],["半径5km",5],["半径10km",10],["半径20km",20]],
                                   params[:radius_km]),
                class: "form-select form-select-lg rounded-3" %>
        </div>
        <div class="col-12 col-md-auto">
          <%= submit_tag "この条件で検索", class: "btn btn-dark btn-lg w-100 rounded-3" %>
        </div>
        <div class="col-12 col-md-auto">
          <input type="hidden" name="lat" id="search-lat" value="<%= params[:lat] %>">
          <input type="hidden" name="lng" id="search-lng" value="<%= params[:lng] %>">
          <button type="button" id="geo-btn" class="btn btn-primary btn-lg w-100 rounded-3">現在地で探す</button>
        </div>
      <% end %>
    </div>

    <!-- 適用中フィルタのチップ表示 -->
    <div class="mb-3">
      <div class="d-flex flex-wrap align-items-center gap-2 small">
        <span class="text-muted">該当 <strong><%= @posts.size %></strong> 件</span>
        <% if params[:place].present? %><span class="badge bg-light text-dark border">場所: <%= params[:place] %></span><% end %>
        <% if params[:q].present? %><span class="badge bg-light text-dark border">キーワード: <%= params[:q] %></span><% end %>
        <% if params[:genre_id].present? %>
          <% if (g = @genres.find{|x| x.id.to_s == params[:genre_id].to_s }) %>
            <span class="badge bg-light text-dark border">ジャンル: <%= g.name %></span>
          <% end %>
        <% end %>
        <% if params[:radius_km].present? %><span class="badge bg-light text-dark border">半径: <%= params[:radius_km] %>km</span><% end %>
        <% if @center_lat.present? && @center_lng.present? %>
          <span class="badge bg-light text-dark border">基準: <code><%= @center_lat %>, <%= @center_lng %></code></span>
        <% end %>
      </div>
    </div>

    <!-- 検索結果 -->
    <div class="row g-4">
      <% if @posts.present? %>
        <% @posts.each do |post| %>
          <div class="col-12 col-sm-6 col-lg-3">
            <%= render "card", post: post %>
          </div>
        <% end %>
      <% else %>
        <div class="col-12">
          <div class="text-center text-muted py-5">条件に合うお店が見つかりませんでした。</div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
(function(){
  const btn = document.getElementById('geo-btn');
  if(!btn) return;
  btn.addEventListener('click', function(){
    if(!navigator.geolocation){ alert('位置情報が使えません'); return; }
    navigator.geolocation.getCurrentPosition(function(pos){
      document.getElementById('search-lat').value = pos.coords.latitude;
      document.getElementById('search-lng').value = pos.coords.longitude;
      btn.closest('form').requestSubmit();
    }, function(err){ alert('位置情報の取得に失敗: ' + err.message); });
  });
})();
</script>