
<%= render 'posts/detail_map' %>

<div class="container py-5">

  
  <div class="d-flex align-items-center justify-content-between mb-4">
   
    <div class="d-flex align-items-center gap-3 text-start">
      <%= link_to user_path(@post.user), class: "d-inline-flex align-items-center" do %>
        <% if @post.user&.avatar&.attached? %>
          <%= image_tag @post.user.avatar.variant(resize_to_fill: [50, 50]),
                class: "rounded-circle border", alt: "#{@post.user.name}のアイコン" %>
        <% else %>
          <div class="rounded-circle bg-light border d-inline-flex align-items-center justify-content-center"
               style="width:50px;height:50px;">
            <span class="fw-bold text-muted"><%= @post.user.name.to_s.first&.upcase || "?" %></span>
          </div>
        <% end %>
      <% end %>

      <div>
        <h1 class="h4 mb-1"><%= @post.title %></h1>
        <div class="small text-muted">
          <%= link_to @post.user.name, user_path(@post.user), class: "fw-semibold text-dark text-decoration-none" %>
          ・ <%= l @post.created_at, format: :short %>
        </div>
      </div>
    </div>

   
    <div class="ms-3">
      <%= link_to "← 戻る", posts_path, class: "btn btn-sm btn-outline-secondary" %>
    </div>
  </div>

 
  <div class="col-md-8 mx-auto text-center">

    <p class="mb-3 text-start"><%= simple_format(h(@post.body)) %></p>

   
    <div class="mb-3 small text-muted">
      <% if @post.store_name.present? %>
        <span class="me-2">店名: <%= @post.store_name %></span>
      <% end %>
      <% if @post.genre&.name.present? %>
        <span class="me-2">ジャンル: <%= @post.genre.name %></span>
      <% end %>
      <% if @post.address.present? %>
        <span>住所: <%= @post.address %></span>
      <% end %>
    </div>

   
    <% if @post.image.attached? %>
      <div class="my-3">
        <%= image_tag @post.image,
              class: "img-fluid rounded" %>
      </div>
    <% end %>

   
    <div class="mb-3 d-flex flex-wrap justify-content-center gap-2">
      <% if user_signed_in? && @post.user_id == current_user.id %>
        <%= link_to "編集", edit_post_path(@post), class: "btn btn-sm btn-outline-primary" %>
        <%= button_to "削除", post_path(@post),
              method: :delete,
              data: { confirm: "本当に削除しますか？" },
              class: "btn btn-sm btn-outline-danger" %>
      <% end %>
    </div>

   
    <div class="d-flex justify-content-center align-items-center gap-3 my-3">
      <div>❤ <strong><%= @post.likes_count || @post.likes.size %></strong></div>

      <% if user_signed_in? %>
        <% if @post.liked_by?(current_user) %>
          <% my_like = @post.likes.find_by(user_id: current_user.id) %>
          <%= button_to "いいね解除", post_like_path(@post, my_like),
                method: :delete, class: "btn btn-sm btn-outline-danger" %>
        <% else %>
          <%= button_to "いいね", post_likes_path(@post),
                method: :post, class: "btn btn-sm btn-outline-primary" %>
        <% end %>
      <% else %>
        <%= link_to "ログインしていいね", new_user_session_path, class: "btn btn-sm btn-outline-primary" %>
      <% end %>
    </div>

    <hr>

   
    <h2 class="h5 mt-4 mb-3">コメント（<%= @comments.size %>）</h2>

   
    <div class="mb-4 text-start">
      <% @comments.each do |c| %>
        <div class="border rounded p-3 mb-2">
          <div class="small text-muted">
            <strong><%= c.user&.name || c.user&.email %></strong>
            ・ <%= l c.created_at, format: :short %>
          </div>
          <div class="mt-1"><%= simple_format(h(c.body)) %></div>

          <% if user_signed_in? && (c.user_id == current_user.id) %>
            <div class="mt-2">
              <%= button_to "削除", post_comment_path(@post, c),
                    method: :delete,
                    data: { confirm: "このコメントを削除しますか？" },
                    class: "btn btn-sm btn-outline-danger" %>
            </div>
          <% end %>
        </div>
      <% end %>

      <% if @comments.blank? %>
        <div class="text-muted">まだコメントはありません。</div>
      <% end %>
    </div>

    
    <% if user_signed_in? %>
      <div class="card p-3 text-start">
        <% if @comment.errors.any? %>
          <div class="alert alert-danger">
            <ul class="mb-0">
              <% @comment.errors.full_messages.each do |m| %>
                <li><%= m %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <%= form_with model: [@post, @comment], local: true do |f| %>
          <div class="mb-2">
            <%= f.text_area :body, rows: 3, class: "form-control", placeholder: "コメントを書く…" %>
          </div>
          <%= f.submit "送信", class: "btn btn-primary" %>
        <% end %>
      </div>
    <% else %>
      <div class="alert alert-warning">
        コメントするには <%= link_to "ログイン", new_user_session_path %> が必要です。
      </div>
    <% end %>

  </div>
</div>

<%= render 'posts/detail_map_js' %>